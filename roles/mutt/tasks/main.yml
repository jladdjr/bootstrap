- include_vars: mutt_secrets.yml

- name: Create neomutt repo repo
  copy:
    src: flatcap-neomutt-epel-7.repo
    dest: /etc/yum.repos.d
  become: true

- name: Install mutt + dependencies
  yum: name={{ item }} state=present
  with_items:
    - neomutt
    - notmuch
    - msmtp
    - offlineimap
    - lynx
  become: true

- name: Copy system config
  copy:
    src: neomuttrc
    dest: /etc
    mode: 0644
  become: true

- name: Copy config files
  copy:
    src: "{{ item }}"
    dest: /home/vagrant/
    mode: 0600
  with_items:
    - .neomuttrc.work
    - .neomuttrc.personal
    - .notmuch-config

- name: Copy templated config files
  template:
    src: "{{ item }}"
    dest: "/home/vagrant/{{ item|replace('.j2','') }}"
    mode: 0600
  with_items:
    - .offlineimaprc.j2
    - .msmtprc.j2

- name: Copy config folders
  copy:
    src: "{{ item }}"
    dest: /home/vagrant/
    mode: 0700
  with_items:
    - .mutt
    - mapped

- name: Run offlineimap periodically (uncomment job after syncing mail with `offlineimap` for the first time)
  cron:
    name: offlineimap
    minute: "*/8"
    job: "#/usr/bin/offlineimap -1 -u quiet"

- name: Add .bashrc aliases
  blockinfile:
    marker: "# {mark} ANSIBLE MANAGED BLOCK - mutt"
    path: /home/vagrant/.bashrc
    block: |
      alias nm='neomutt -F ~/.neomuttrc.work'
      alias nm2='neomutt -F ~/.neomuttrc.personal'
