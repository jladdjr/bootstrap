- name: Ensure mapped folder exists
  file:
    path: /var/mapped
    state: directory
    mode: 0700

- name: Create neomutt repo
  copy:
    src: neomutt/flatcap-neomutt-epel-7.repo
    dest: /etc/dnf.repos.d
  become: true

# https://neomutt.org/distro/fedora
# * without this copr, see depsolve errors:
#   https://gist.github.com/jladdjr/f99f917dffdf7da4894b9126928eae12)
#- name: Enable neomutt copr
#  shell: dnf copr -y enable flatcap/neomutt
#  args:
#    warn: false  # ansible's dnf module doesn't seem to support enabling copr's
#  become: true

- name: Install neomutt + dependencies
  dnf:
    name: ['neomutt', 'notmuch', 'msmtp']
    state: present
  become: true

- name: Install neomutt dependencies only available via pip
  shell: python3 -m pip install {{ item }}
  with_items:
    - rfc6555 # dep not being installed correctly when pip installing offlineimap
              # error: https://gist.github.com/jladdjr/cbe10df157f1563663090afc4cbe5bd7
    - offlineimap
    - lynx
    - pandoc
  become: true

- name: Update Lynx settings
  lineinfile:
    path: /etc/lynx.cfg
    line: REFERER_WITH_QUERY:PARTIAL
    create: yes
  become: true

- name: Copy neomuttrc to /etc
  copy:
    src: neomutt/neomuttrc
    dest: /etc
    mode: 0644
  become: true

- name: Copy neomutt / notmuch dotfiles
  copy:
    src: "neomutt/{{ item }}"
    dest: "{{ lookup('env', 'HOME') }}/.{{ item }}"
    mode: 0600
  with_items:
    - neomuttrc.work
    - neomuttrc.personal
    - notmuch-config
    - gpg.rc

- name: Create offlineimaprc / msmtprc dotfiles (requires neomutt passwords)
  template:
    src: "{{ item }}"
    dest: "~/.{{ item|replace('.j2','') }}"
    mode: 0600
  with_items:
    - offlineimaprc.j2
    - msmtprc.j2

- name: Create .mutt folder
  copy:
    src: neomutt/mutt/  # copy contents *inside* mutt folder, not folder itself
    dest: "{{ lookup('env', 'HOME') }}/.mutt"
    mode: 0700

- name: Is mapped/.mail folder present?
  command: file /var/mapped/.mail
  register: dotmail

- name: .. if not, create the file
  copy:
    src: neomutt/mapped/mail
    dest: /var/mapped/.mail
    mode: 0700
  when: dotmail.stdout.find('No such file or directory') != -1

- name: Ensure alias file exists in shared folder
  file:
    path: /var/mapped/alias
    state: touch

- name: Run offlineimap periodically (uncomment job after syncing mail with `offlineimap` for the first time)
  cron:
    name: offlineimap
    minute: "*/5"
    job: "bash -c '/usr/bin/imapfilter -l /var/mapped/imapfilter.log -t /etc/ssl/certs/ca-bundle.crt && /usr/bin/offlineimap -1 -u quiet'"

- name: Create folder for storing mutt attachments
  file:
    path: /var/mapped/mutt
    state: directory
    mode: 0700

- name: Create tmp folder for mutt
  file:
    path: /var/mapped/mutt/tmp
    state: directory
    mode: 0700

- name: Add .bashrc aliases
  blockinfile:
    marker: "# {mark} ANSIBLE MANAGED BLOCK - neomutt"
    path: ~/.bashrc
    block: |
      alias n='pushd .; cd /var/mapped/mutt; neomutt -F ~/.neomuttrc.work; popd'
      alias n2='pushd .; cd /var/mapped/mutt; neomutt -F ~/.neomuttrc.personal; popd'

- name: Install / configure imapfilter
  import_tasks: imapfilter.yml
